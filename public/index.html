<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BookVerse - Painel de Teste (Release 02)</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px;
      background: #f6f6f6;
      color: #333;
    }
    h1, h2, h3 {
      color: #444;
      border-bottom: 2px solid #ddd;
      padding-bottom: 5px;
    }
    form {
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    input, textarea {
      display: block;
      margin: 8px 0;
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box; /* Para incluir padding na largura */
    }
    button {
      padding: 8px 12px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    button.delete { background: #dc3545; }
    button.update-btn { background: #ffc107; color: #333; }
    button:hover { opacity: 0.9; }
    .list {
      display: grid;
      gap: 10px;
      margin-bottom: 30px;
    }
    .card {
      background: #fff;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 0 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-content { flex-grow: 1; }
    .card-actions { margin-left: 10px; }
    small { color: #777; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>BookVerse - Painel de Teste (Release 02)</h1>
  <p>4 CRUDs implementados: Autor, Livro, Usuário e Categoria.</p>

  <hr/>
  
  <h2>Autor (RF03.x)</h2>
  <h3>Criar Autor</h3>
  <form id="formAutor">
    <input type="text" id="autorNome" placeholder="Nome" required />
    <input type="text" id="autorBio" placeholder="Biografia" />
    <input type="text" id="autorNac" placeholder="Nacionalidade" />
    <button type="submit">Criar Autor</button>
  </form>

  <h3>Listagem de Autores (Consultar, Atualizar, Excluir)</h3>
  <div id="listaAutores" class="list"></div>

  <hr/>

  <h2>Livro (RF02.x)</h2>
  <h3>Criar Livro</h3>
  <form id="formLivro">
    <input type="text" id="livroTitulo" placeholder="Título" required />
    <input type="text" id="livroDescricao" placeholder="Descrição" />
    <input type="number" id="livroPreco" placeholder="Preço" step="0.01" required />
    <input type="text" id="livroAutorId" placeholder="ID do Autor" required />
    <input type="text" id="livroCategoriaId" placeholder="ID da Categoria (opcional)" />
    <button type="submit">Criar Livro</button>
  </form>

  <h3>Listagem de Livros (Consultar, Atualizar, Excluir)</h3>
  <div id="listaLivros" class="list"></div>

  <hr/>

  <h2>Usuário (RF01.x)</h2>
  <h3>Criar Usuário</h3>
  <form id="formUsuario">
    <input type="text" id="usuarioNome" placeholder="Nome" required />
    <input type="email" id="usuarioEmail" placeholder="E-mail" required />
    <input type="password" id="usuarioSenha" placeholder="Senha" required />
    <button type="submit">Criar Usuário</button>
  </form>

  <h3>Listagem de Usuários (Consultar, Atualizar, Excluir)</h3>
  <div id="listaUsuarios" class="list"></div>

  <hr/>

  <h2>Categoria (RF04.x)</h2>
  <h3>Criar Categoria</h3>
  <form id="formCategoria">
    <input type="text" id="categoriaNome" placeholder="Nome da Categoria" required />
    <button type="submit">Criar Categoria</button>
  </form>

  <h3>Listagem de Categorias (Consultar, Atualizar, Excluir)</h3>
  <div id="listaCategorias" class="list"></div>

  <script>
    const API_BASE = 'http://localhost:3000';

    // --- FUNÇÕES DE UTILIDADE (POST, PUT, DELETE, etc.) ---

    async function fetchData(url) {
        const res = await fetch(url);
        if (!res.ok) {
            const error = await res.json();
            alert('Erro ao carregar dados: ' + error.error);
            return [];
        }
        return res.json();
    }

    async function handlePost(url, data, callback) {
        try {
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (!res.ok) {
                alert('Erro ao criar: ' + result.error);
                return;
            }
            callback();
        } catch (error) {
            alert('Erro de conexão ao criar.');
        }
    }

    async function handleUpdate(url, id, data, callback) {
        try {
            const res = await fetch(`${url}/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (!res.ok) {
                alert('Erro ao atualizar: ' + result.error);
                return;
            }
            callback();
        } catch (error) {
            alert('Erro de conexão ao atualizar.');
        }
    }

    async function handleDelete(url, id, callback) {
        if (!confirm("Tem certeza que deseja excluir?")) return;
        try {
            const res = await fetch(`${url}/${id}`, { method: "DELETE" });
            if (res.status === 400) {
                 // Regra de Negócio Violada
                const error = await res.json();
                alert('Regra de Negócio Violada: ' + error.error);
                return;
            }
            if (!res.ok && res.status !== 204) {
                alert('Erro ao excluir. Status: ' + res.status);
                return;
            }
            callback();
        } catch (error) {
            alert('Erro de conexão ao excluir.');
        }
    }


    // --- MÓDULO AUTOR (C, R, U, D) ---

    async function carregarAutores() {
        const autores = await fetchData(`${API_BASE}/authors`);
        const lista = document.getElementById("listaAutores");
        lista.innerHTML = "";
        autores.forEach(a => {
            const el = document.createElement("div");
            el.className = "card";
            el.setAttribute('data-id', a.id);
            el.innerHTML = `
                <div class="card-content">
                    <strong>${a.name}</strong><br>
                    <small>Nacionalidade: ${a.nationality || "N/A"}</small><br>
                    <small>ID: ${a.id}</small>
                </div>
                <div class="card-actions">
                    <button class="update-btn" onclick="iniciarEdicao('autor', '${a.id}', '${a.name}', '${a.biography || ''}', '${a.nationality || ''}')">Atualizar</button>
                    <button class="delete" onclick="handleDelete('${API_BASE}/authors', '${a.id}', carregarAutores)">Excluir</button>
                </div>
            `;
            lista.appendChild(el);
        });
    }

    document.getElementById("formAutor").addEventListener("submit", async (e) => {
        e.preventDefault();
        const autor = {
            name: autorNome.value,
            biography: autorBio.value,
            nationality: autorNac.value
        };
        await handlePost(`${API_BASE}/authors`, autor, () => {
            autorNome.value = autorBio.value = autorNac.value = "";
            carregarAutores();
            carregarLivros(); // Atualiza a lista de livros que pode depender do autor
        });
    });


    // --- MÓDULO LIVRO (C, R, U, D) ---

    async function carregarLivros() {
        const livros = await fetchData(`${API_BASE}/books?expand=author,category`);
        const lista = document.getElementById("listaLivros");
        lista.innerHTML = "";
        livros.forEach(l => {
            const el = document.createElement("div");
            el.className = "card";
            el.setAttribute('data-id', l.id);
            el.innerHTML = `
                <div class="card-content">
                    <strong>${l.title}</strong><br>
                    <small>Preço: R$ ${l.price}</small><br>
                    <small>Autor: ${l.author ? l.author.name : l.authorId}</small><br>
                    <small>Categoria: ${l.category ? l.category.name : "N/A"}</small><br>
                    <small>ID: ${l.id}</small>
                </div>
                <div class="card-actions">
                    <button class="update-btn" onclick="iniciarEdicao('livro', '${l.id}', '${l.title}', '${l.price}', '${l.authorId}')">Atualizar</button>
                    <button class="delete" onclick="handleDelete('${API_BASE}/books', '${l.id}', carregarLivros)">Excluir</button>
                </div>
            `;
            lista.appendChild(el);
        });
    }

    document.getElementById("formLivro").addEventListener("submit", async (e) => {
        e.preventDefault();
        const livro = {
            title: livroTitulo.value,
            description: livroDescricao.value,
            price: Number(livroPreco.value),
            authorId: livroAutorId.value,
            categoryId: livroCategoriaId.value || null
        };
        await handlePost(`${API_BASE}/books`, livro, () => {
            livroTitulo.value = livroDescricao.value = livroPreco.value = livroAutorId.value = livroCategoriaId.value = "";
            carregarLivros();
        });
    });


    // --- MÓDULO USUÁRIO (C, R, U, D) ---

    async function carregarUsuarios() {
        const usuarios = await fetchData(`${API_BASE}/users`);
        const lista = document.getElementById("listaUsuarios");
        lista.innerHTML = "";
        usuarios.forEach(u => {
            const el = document.createElement("div");
            el.className = "card";
            el.setAttribute('data-id', u.id);
            el.innerHTML = `
                <div class="card-content">
                    <strong>${u.name}</strong><br>
                    <small>Email: ${u.email}</small><br>
                    <small>ID: ${u.id}</small>
                </div>
                <div class="card-actions">
                    <button class="update-btn" onclick="iniciarEdicao('usuario', '${u.id}', '${u.name}', '${u.email}')">Atualizar</button>
                    <button class="delete" onclick="handleDelete('${API_BASE}/users', '${u.id}', carregarUsuarios)">Excluir</button>
                </div>
            `;
            lista.appendChild(el);
        });
    }

    document.getElementById("formUsuario").addEventListener("submit", async (e) => {
        e.preventDefault();
        const usuario = {
            name: usuarioNome.value,
            email: usuarioEmail.value,
            password: usuarioSenha.value
        };
        await handlePost(`${API_BASE}/users`, usuario, () => {
            usuarioNome.value = usuarioEmail.value = usuarioSenha.value = "";
            carregarUsuarios();
        });
    });


    // --- MÓDULO CATEGORIA (C, R, U, D) ---

    async function carregarCategorias() {
        const categorias = await fetchData(`${API_BASE}/categories`);
        const lista = document.getElementById("listaCategorias");
        lista.innerHTML = "";
        categorias.forEach(c => {
            const el = document.createElement("div");
            el.className = "card";
            el.setAttribute('data-id', c.id);
            el.innerHTML = `
                <div class="card-content">
                    <strong>${c.name}</strong><br>
                    <small>ID: ${c.id}</small>
                </div>
                <div class="card-actions">
                    <button class="update-btn" onclick="iniciarEdicao('categoria', '${c.id}', '${c.name}')">Atualizar</button>
                    <button class="delete" onclick="handleDelete('${API_BASE}/categories', '${c.id}', carregarCategorias)">Excluir</button>
                </div>
            `;
            lista.appendChild(el);
        });
    }

    document.getElementById("formCategoria").addEventListener("submit", async (e) => {
        e.preventDefault();
        const categoria = {
            name: categoriaNome.value
        };
        await handlePost(`${API_BASE}/categories`, categoria, () => {
            categoriaNome.value = "";
            carregarCategorias();
            carregarLivros(); // Atualiza a lista de livros que pode depender da categoria
        });
    });

    // --- FUNÇÃO GENÉRICA DE EDIÇÃO/ATUALIZAÇÃO (Front-end Simplificado) ---
    function iniciarEdicao(modulo, id, ...valores) {
        const cardElement = document.querySelector(`.card[data-id="${id}"]`);
        if (!cardElement) return;

        const updateFormId = `updateForm-${id}`;
        let updateForm = document.getElementById(updateFormId);

        if (updateForm) {
            cardElement.removeChild(updateForm);
            return;
        }

        updateForm = document.createElement('form');
        updateForm.id = updateFormId;
        updateForm.style.marginTop = '10px';
        updateForm.className = 'update-form';
        
        const fields = [];
        let url = '';
        let reloadFn;
        let updateData = {};

        switch(modulo) {
            case 'autor':
                url = `${API_BASE}/authors`;
                reloadFn = carregarAutores;
                fields.push({ key: 'name', placeholder: 'Novo Nome', value: valores[0] });
                fields.push({ key: 'biography', placeholder: 'Nova Biografia', value: valores[1] });
                fields.push({ key: 'nationality', placeholder: 'Nova Nacionalidade', value: valores[2] });
                break;
            case 'livro':
                url = `${API_BASE}/books`;
                reloadFn = carregarLivros;
                fields.push({ key: 'title', placeholder: 'Novo Título', value: valores[0] });
                fields.push({ key: 'price', placeholder: 'Novo Preço', type: 'number', step: '0.01', value: valores[1] });
                fields.push({ key: 'authorId', placeholder: 'Novo ID do Autor', value: valores[2] });
                break;
            case 'usuario':
                url = `${API_BASE}/users`;
                reloadFn = carregarUsuarios;
                fields.push({ key: 'name', placeholder: 'Novo Nome', value: valores[0] });
                fields.push({ key: 'email', placeholder: 'Novo E-mail', type: 'email', value: valores[1] });
                fields.push({ key: 'password', placeholder: 'Nova Senha (deixe vazio para não alterar)', type: 'password', value: '' });
                break;
            case 'categoria':
                url = `${API_BASE}/categories`;
                reloadFn = carregarCategorias;
                fields.push({ key: 'name', placeholder: 'Novo Nome da Categoria', value: valores[0] });
                break;
        }
        
        fields.forEach(f => {
            const input = document.createElement('input');
            input.type = f.type || 'text';
            input.placeholder = f.placeholder;
            input.value = f.value;
            input.step = f.step || '';
            input.id = `input-${modulo}-${id}-${f.key}`;
            updateForm.appendChild(input);
        });

        const saveButton = document.createElement('button');
        saveButton.type = 'submit';
        saveButton.textContent = 'Salvar Alterações';
        updateForm.appendChild(saveButton);

        updateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            fields.forEach(f => {
                const value = document.getElementById(`input-${modulo}-${id}-${f.key}`).value;
                if (value.trim() !== '' && (f.key !== 'password' || value.trim() !== '')) {
                     // Converte preço para número
                    updateData[f.key] = f.key === 'price' ? Number(value) : value; 
                }
            });

            await handleUpdate(url, id, updateData, () => {
                reloadFn();
                if (modulo === 'autor' || modulo === 'categoria') {
                    carregarLivros(); // Recarrega livros se autor/categoria mudar
                }
            });
            cardElement.removeChild(updateForm); // Remove formulário após salvar
        });

        cardElement.appendChild(updateForm);
    }


    // Inicializa todos os carregamentos
    carregarAutores();
    carregarLivros();
    carregarUsuarios();
    carregarCategorias();

  </script>
</body>
</html>